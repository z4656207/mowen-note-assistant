# 侧边栏标签页切换问题修复

## 问题描述

在侧边栏模式下，用户执行发布任务后切换到其他网页时，侧边栏仍然显示之前的网页信息和处理结果。再次点击发布时，处理的还是之前的网页内容，而不是当前活动标签页的内容。

## 问题原因

侧边栏缺少对标签页切换事件的监听机制，导致：
1. 页面信息未自动更新
2. 任务状态和结果未清理
3. 页面内容数据仍然是旧标签页的数据

## 解决方案

### 1. 添加标签页切换监听器

在 `sidepanel.js` 中新增了以下功能：

- **setupTabChangeListener()**: 定期检查活动标签页是否变化
- **setupVisibilityListener()**: 监听页面可见性变化
- **setupUnloadListener()**: 页面卸载时清理资源

### 2. 智能任务状态管理

- **handleTabChange(newTab)**: 智能处理标签页切换
   - 检测任务执行状态，决定是否保留任务监控
   - 任务进行中时保留状态，避免中断
   - 重新加载页面信息并检查新标签页任务
   - 显示适当的状态提示信息
- **resetSidePanelState()**: 完整重置侧边栏状态
- **refreshPageInfo()**: 刷新页面信息的统一入口
- **showTaskStartNotice()**: 任务开始时的用户提示

### 3. 资源清理

- **cleanup()**: 清理定时器和轮询间隔
- 页面卸载时自动清理资源，避免内存泄漏

### 4. 用户体验改进

- **任务执行提示**: 开始任务时显示详细的操作说明
- **状态保护**: 任务进行中切换标签页不会中断任务
- **智能提示**: 根据切换情况显示不同的状态信息

## 具体修改内容

### 新增方法

1. **setupTabChangeListener()** - 设置标签页切换监听器
   - 每秒检查一次当前活动标签页
   - 检测到切换时自动处理

2. **setupVisibilityListener()** - 设置页面可见性监听器
   - 侧边栏重新可见时刷新页面信息

3. **setupUnloadListener()** - 设置页面卸载监听器
   - 页面关闭前清理所有资源

4. **handleTabChange(newTab)** - 智能处理标签页切换
   - 检测任务执行状态，决定是否保留任务监控
   - 任务进行中时保留状态，避免中断
   - 重新加载页面信息并检查新标签页任务
   - 显示适当的状态提示信息

5. **resetSidePanelState()** - 重置侧边栏状态
   - 停止轮询
   - 重置任务状态
   - 隐藏进度和结果
   - 重置按钮状态
   - 清空显示信息

6. **refreshPageInfo()** - 刷新页面信息
   - 统一的页面信息刷新入口
   - 包含错误处理

7. **cleanup()** - 清理资源
   - 清理所有定时器
   - 防止内存泄漏

8. **showTaskStartNotice()** - 任务开始提示
   - 显示任务执行说明
   - 告知用户可以安全切换标签页
   - 自动隐藏提示信息

### 修改现有方法

1. **loadPageInfo()** - 加载页面信息时记录当前标签页ID
2. **initSidePanelFeatures()** - 初始化时调用新的监听器设置

## 测试步骤

### 基本功能测试

1. **安装扩展并打开侧边栏**
   ```
   1. 加载扩展到Chrome
   2. 打开任意网页
   3. 点击扩展图标打开侧边栏
   4. 验证页面信息正确显示
   ```

2. **标签页切换测试**
   ```
   1. 在侧边栏中查看当前页面信息
   2. 切换到另一个标签页
   3. 等待1-2秒（监听器检查间隔）
   4. 验证侧边栏显示新页面的信息
   ```

3. **任务状态重置测试**
   ```
   1. 在标签页A执行发布任务
   2. 任务完成后显示结果
   3. 切换到标签页B
   4. 验证：
      - 页面信息更新为标签页B
      - 之前的任务结果已清除
      - 按钮状态已重置
   ```

### 高级场景测试

4. **任务进行中切换标签页**
   ```
   1. 在标签页A开始发布任务
   2. 观察任务开始提示信息（6秒后消失）
   3. 任务进行中切换到标签页B
   4. 验证：
      - 显示"任务将在后台继续进行"提示
      - 标签页B显示新页面信息
      - 切换回标签页A时恢复任务状态和进度
      - 任务完成时能正常显示结果
   ```

5. **页面可见性切换测试**
   ```
   1. 打开侧边栏
   2. 切换到其他应用或最小化浏览器
   3. 重新激活浏览器
   4. 验证页面信息自动刷新
   ```

6. **资源清理测试**
   ```
   1. 打开侧边栏并执行任务
   2. 关闭标签页或浏览器
   3. 重新打开，验证没有残留状态
   ```

### 性能测试

7. **频繁切换标签页**
   ```
   1. 快速在多个标签页间切换
   2. 观察控制台是否有错误
   3. 验证内存使用是否正常
   ```

## 预期效果

修复后，侧边栏应该表现为：

1. **自动同步**: 标签页切换时自动更新页面信息
2. **状态隔离**: 不同标签页的任务状态独立管理
3. **清理彻底**: 切换时完全清理旧状态
4. **响应及时**: 1秒内检测到标签页变化
5. **资源友好**: 正确清理定时器，无内存泄漏

## 注意事项

1. **检查间隔**: 标签页检查间隔设为1秒，平衡了响应性和性能
2. **错误处理**: 所有异步操作都包含错误处理
3. **兼容性**: 保持与现有功能的完全兼容
4. **调试信息**: 添加了详细的控制台日志便于调试

## 调试信息

在浏览器控制台中可以看到以下调试信息：

- `检测到标签页切换: [旧ID] -> [新ID]`
- `处理标签页切换: [ID] [URL]`
- `重置侧边栏状态`
- `页面信息刷新完成`
- `侧边栏重新可见，刷新页面信息`

## 回退方案

如果新功能出现问题，可以：

1. 注释掉 `initSidePanelFeatures()` 中的新监听器调用
2. 移除新增的方法
3. 恢复到原有的手动刷新行为

这样的设计确保了向后兼容性和稳定性。 